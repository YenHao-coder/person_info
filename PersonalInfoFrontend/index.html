<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>個人資料管理系統</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link href="css/style.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div id="alertPlaceholder"></div>
    <div id="app" class="container mt-4">
      <h1 class="mb-4 text-center">個人資料管理系統</h1>
      <div class="card mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <ul class="nav nav-tabs card-header-pills" role="tablist">
            <li class="nav-item" role="presentation">
              <router-link
                to="/charts/gender"
                class="nav-link"
                aria-current="page"
                active-class="active"
                >性別分佈</router-link
              >
            </li>
            <li class="nav-item" role="presentation">
              <router-link
                to="/charts/age"
                class="nav-link"
                active-class="active"
                >年齡分佈</router-link
              >
            </li>
            <li class="nav-item" role="presentation">
              <router-link
                to="/charts/trend"
                class="nav-link"
                active-class="active"
                >趨勢分析</router-link
              >
            </li>
            <li class="nav-item" role="presentation">
              <router-link to="/history" class="nav-link" active-class="active">修改版本</router-link>
            </li>
          </ul>
          <button class="btn btn-outline-primary ms-auto" @click="printChart" id="btnprint">
            <i class="bi bi-printer"></i> 列印
          </button>
        </div>
        <div class="card-body">
          <router-view></router-view>

          <div v-if="$route.path === '/'" class="text-center text-muted">
            請從上方頁籤選擇一個圖表進行查看。
          </div>
        </div>
      </div>
      
      <div class="row mb-3" id="searchField">
        <div class="col-md-6">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              placeholder="輸入姓名或 Email 進行搜尋..."
              :value="searchQuery"
              @input="searchQuery = $event.target.value"
            />
            <span
              ><button class="btn btn-secondary ms-2" @click="performSearch">
                搜尋
              </button>
              <button
                class="btn btn-outline-secondary ms-2"
                type="button"
                @click="clearSearch"
              >
                清除
              </button></span
            >
          </div>
        </div>
      </div>
      <div class="table-responstive" v-if="persons.length > 0">
        <table class="table table-striped table-bordered table-hover">
          <thead class="table-info">
            <tr>
              <th>姓名</th>
              <th>性別</th>
              <th>生日</th>
              <th>地址</th>
              <th>Email</th>
              <th>電話</th>
              <th id="btnTableThead">操作</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="person in persons" :key="person.id">
              <td>{{person.name}}</td>
              <td>{{person.gender || '無'}}</td>
              <td>{{formatDate(person.dateOfBirth)}}</td>
              <td>{{person.address || '無'}}</td>
              <td>{{person.email}}</td>
              <td>{{person.phoneNumber || '無'}}</td>
              <td id="btnTableTbody">
                <button
                  class="btn btn-sm btn-outline-info me-2"
                  @click="viewPerson(person)"
                >
                  查看
                </button>
                <button
                  class="btn btn-sm btn-outline-warning me-2"
                  @click="editPerson(person)"
                >
                  編輯
                </button>
                <button
                  class="btn btn-sm btn-danger me-2"
                  @click="confirmDelete(person.id)"
                >
                  刪除
                </button>
              </td>              
            </tr>
          </tbody>
        </table>
      </div>
      <div v-else class="alert alert-info text-center" role="alert">
        目前沒有個人資料，請新增
      </div>
      <div class="accordion mb-4" id="addPersonAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingAddPerson">
            <button
              class="accordion-button bg-primary text-white"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseAddPerson"
              aria-expanded="true"
              aria-controls="collapseAddPerson"
            >
              + 新增一筆 。。。
            </button>
          </h2>
          <div
            id="collapseAddPerson"
            class="accordion-collapse collapse show"
            aria-labelledby="headingAddPerson"
            data-bs-parent="#addPersonAccordion"
          >
            <div class="accordion-body">
              <form @submit.prevent="addPerson">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="name" class="form-label"
                      >姓名<span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      name="name"
                      id="name"
                      class="form-control"
                      v-model="newPerson.name" @input="validateField('newPerson', 'name')" :class="{'is-invalid': errors.name}" />
                      <div class="invalid-feedback" v-if="errors.name">
                      {{ errors.name }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label"
                      >Email<span class="text-danger">*</span></label
                    >
                    <input
                      type="email"
                      name="email"
                      id="email"
                      class="form-control"
                      v-model="newPerson.email"
                      :class="{'is-invalid': errors.email}"
                      v-model="newPerson.email"
                      @input="validateField('newPerson', 'email')"
                    />
                    <div class="invalid-feedback" v-if="errors.email">
                      {{ errors.email }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="dateOfBirth" class="form-label"
                      >生日<span class="text-danger">*</span></label
                    >
                    <input
                      type="date"
                      name="dateOfBirth"
                      id="dateOfBirth"
                      class="form-control"
                      :class="{'is-invalid': errors.dateOfBirth}"
                      v-model="newPerson.dateOfBirth"
                      @input="validateField('newPerson', 'dateOfBirth')"/>
                      <div class="invalid-feedback" v-if="errors.dateOfBirth">
                      {{ errors.dateOfBirth }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="address" class="form-label">地址</label>
                    <input
                      type="text"
                      name="address"
                      id="address"
                      class="form-control"
                      :class="{'is-invalid': errors.address}"
                      v-model="newPerson.address"
                      @input="validateField('newPerson', 'address')"/>
                      <div class="invalid-feedback" v-if="errors.address">
                      {{ errors.address }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="phoneNumber" class="form-label">電話</label>
                    <input
                      type="tel"
                      name="phoneNumber"
                      id="phoneNumber"
                      class="form-control"
                      :class="{'is-invalid': errors.phoneNumber}"
                      v-model="newPerson.phoneNumber"
                      @input="validateField('newPerson', 'phoneNumber')"/>
                      <div class="invalid-feedback" v-if="errors.phoneNumber">
                      {{ errors.phoneNumber }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="gender" class="form-label">性別</label>
                    <select
                      name="gender"
                      id="gender"
                      class="form-select"
                      v-model="newPerson.gender"
                      :class="{'is-invalid': errors.gender}"
                      v-model="newPerson.gender"
                      @change="validateField('newPerson', 'gender')"
                    >
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                      <option value="其他">其他</option>
                    </select>
                    <div class="invalid-feedback" v-if="errors.gender">
                      {{ errors.gender }}
                    </div>
                  </div>
                  <div class="col-12 text-center">
                    <button
                      type="submit"
                      class="btn btn-info me-2"
                      :disabled="isLoading"
                    >
                      <span
                        v-if="isLoading"
                        class="spinner-border spinner-border-sm"
                        role="status"
                        aria-hidden="true"
                      ></span
                      >{{ isLoading? 'loading' : 'Add'}}</button
                    ><button
                      type="button"
                      class="btn btn-outline-info"
                      @click="resetForm"
                    >
                      Reset
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <div v-if="isLoadingData" class="text-center mt-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>資料加載中...</p>
      </div>
      <div v-if="errorMessage" class="alert alert-danger mt-3" role="alert">
        {{ errorMessage }}
      </div>
      <div class="alert alert-success mt-3" role="alert" v-if="successMessage">
        {{ successMessage }}
      </div>

      <div
        class="modal fade"
        id="editPersonModal"
        tabindex="-1"
        aria-labelledby="editPersonModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
              <h5 class="modal-title" id="editPersonModalLabel">
                編輯個人資料
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                @click="cancelEdit"
              ></button>
            </div>
            <div class="modal-body">
              <form v-if="editingPerson" @submit.prevent="updatePerson">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="editName" class="form-label"
                      >姓名 <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editName"
                      :class="{'is-invalid': editErrors.name}"
                      v-model="editingPerson.name"
                      @input="validateField('editingPerson', 'name')"/>
                      <div class="invalid-feedback" v-if="editErrors.name">
                      {{ editErrors.name }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="editEmail" class="form-label"
                      >Email <span class="text-danger">*</span></label
                    >
                    <input
                      type="email"
                      class="form-control"
                      id="editEmail"
                      :class="{'is-invalid': editErrors.email}"
                      v-model="editingPerson.email"
                      @input="validateField('editingPerson', 'email')"/>
                      <div class="invalid-feedback" v-if="editErrors.email">
                      {{ editErrors.email }}
                    </div>                    
                  </div>
                  <div class="col-md-6">
                    <label for="editDateOfBirth" class="form-label"
                      >生日 <span class="text-danger">*</span></label
                    >
                    <input
                      type="date"
                      class="form-control"
                      id="editDateOfBirth"
                      :class="{'is-invalid': editErrors.dateOfBirth}"
                      v-model="editingPerson.dateOfBirth"
                      @input="validateField('editingPerson', 'dateOfBirth')"/><div class="invalid-feedback" v-if="editErrors.dateOfBirth">
                      {{ editErrors.dateOfBirth }}
                    </div>
                      
                  </div>
                  <div class="col-md-6">
                    <label for="editAddress" class="form-label">地址</label>
                    <input
                      type="text"
                      class="form-control"
                      id="editAddress"
                      :class="{'is-invalid': editErrors.address}"
                      v-model="editingPerson.address"
                      @input="validateField('editingPerson', 'address')"/><div class="invalid-feedback" v-if="editErrors.address">
                      {{ editErrors.address }}
                    </div>
                      
                  </div>
                  <div class="col-md-6">
                    <label for="editPhoneNumber" class="form-label">電話</label>
                    <input
                      type="tel"
                      class="form-control"
                      id="editPhoneNumber"
                      :class="{'is-invalid': editErrors.phoneNumber}"
                      v-model="editingPerson.phoneNumber"
                      @input="validateField('editingPerson', 'phoneNumber')"
                    /><div class="invalid-feedback" v-if="editErrors.phoneNumber">
                      {{ editErrors.phoneNumber }}
                  </div>                 
                  </div>
                  <div class="col-md-6">
                    <label for="editGender" class="form-label">性別</label>
                    <select
                      class="form-select"
                      id="editGender"
                      :class="{'is-invalid': editErrors.gender}"
                      v-model="editingPerson.gender"
                      @change="validateField('editingPerson', 'gender')">
                      <option value="">請選擇</option>
                      <option value="男">男</option>
                      <option value="女">女</option>
                      <option value="其他">其他</option>
                    </select>
                    <div class="invalid-feedback" v-if="editErrors.gender">
                      {{ editErrors.gender }}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="editVersion" class="form-label">版本號</label>
                    <input
                      type="text"
                      class="form-control"
                      id="editVersion"
                      :value="editingPerson.version"
                      readonly
                    />
                  </div>
                  <div class="col-md-6">
                    <label for="editLastModified" class="form-label"
                      >上次修改</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="editLastModified"
                      :value="formatDate(editingPerson.lastModified)"
                      readonly
                    />
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
                @click="cancelEdit"
              >
                取消
              </button>
              <button
                type="submit"
                class="btn btn-warning"
                form="editPersonModalForm"
                :disabled="isLoading"
                @click="updatePerson"
              >
                <span
                  v-if="isLoading"
                  class="spinner-border spinner-border-sm"
                  role="status"
                  aria-hidden="true"
                ></span>
                {{ isLoading ? '儲存中...' : '儲存變更' }}
              </button>
            </div>
          </div>
        </div>
        </div>
        <div class="d-flex justify-content-center mt-3">
          <nav aria-label="Page navigation example">
            <ul class="pagination" id="pagination">
              <li class="page-item" :class="{'disabled':currentPage === 1}">
                <a
                  href="#"
                  class="page-link"
                  @click.prevent="goToPage(currentPage - 1)"
                  >prev</a
                >
              </li>
              <li
                class="page-item"
                v-for="page in pageNumbers"
                :key="page"
                :class="{'active' : page === currentPage }"
              >
                <a href="#" class="page-link" @click.prevent="goToPage(page)"
                  >{{ page }}</a
                >
              </li>
              <li
                class="page-item"
                :class="{'disabled':currentPage === totalPages || totalPages === 0}"
              >
                <a
                  href="#"
                  class="page-link"
                  @click.prevent="goToPage(currentPage + 1)"
                  >next</a
                >
              </li>
            </ul>
          </nav>
      </div>
      <p class="text-muted text-center mt-5" id="footer">前端基礎結構已準備就緒。</p>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="js/main.js"></script>
  </body>
</html>
